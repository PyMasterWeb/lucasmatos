<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Estrutura de Pastas - Supabase</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .log-output {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .success { color: #00ff00; }
    .error { color: #ff6b6b; }
    .info { color: #74c0fc; }
    .warning { color: #ffd43b; }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">ğŸš€ Criar Estrutura de Pastas - Supabase Storage</h4>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <strong>âš ï¸ IMPORTANTE:</strong> Este script criarÃ¡ automaticamente toda a estrutura de pastas no Supabase Storage.
          <br>VocÃª sÃ³ precisa executar uma vez!
        </div>

        <div>
          <label class="form-label"><strong>Turmas a criar:</strong></label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="turma6ano" checked>
            <label class="form-check-label" for="turma6ano">6Âº Ano</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="turma7ano" checked>
            <label class="form-check-label" for="turma7ano">7Âº Ano</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="turma8ano" checked>
            <label class="form-check-label" for="turma8ano">8Âº Ano</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="turma9ano" checked>
            <label class="form-check-label" for="turma9ano">9Âº Ano</label>
          </div>
        </div>

        <button class="btn btn-success btn-lg mt-4 w-100" onclick="criarEstrutura()">
          âœ… Criar Estrutura Completa
        </button>

        <div class="log-output" id="logOutput">
          Aguardando inÃ­cio...
        </div>

        <button class="btn btn-secondary mt-3 w-100" onclick="limparLog()">
          ğŸ—‘ï¸ Limpar Log
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://brauqbxjvixrennhyqrk.supabase.co'
    const supabaseKey = 'sb_publishable_4x7IM5uariLJS8hW1YO8KA_bK0sngvi'
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey)

    // Disciplinas (nomes das pastas)
    const DISCIPLINAS = [
      'portugues',
      'matematica',
      'ciencias',
      'historia',
      'geografia',
      'artes',
      'educacaofisica',
      'ingles',
      'socioemocional'
    ];

    // Tipos de conteÃºdo
    const TIPOS = ['material', 'atividade'];

    function addLog(message, type = 'info') {
      const logOutput = document.getElementById('logOutput');
      const timestamp = new Date().toLocaleTimeString();
      const icons = {
        'success': 'âœ…',
        'error': 'âŒ',
        'info': 'â„¹ï¸',
        'warning': 'âš ï¸'
      };
      const icon = icons[type] || 'â€¢';
      const color = type;
      
      const logLine = document.createElement('div');
      logLine.className = color;
      logLine.textContent = `[${timestamp}] ${icon} ${message}`;
      logOutput.appendChild(logLine);
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    function limparLog() {
      document.getElementById('logOutput').innerHTML = 'Log limpo.';
    }

    async function criarEstrutura() {
      addLog('ğŸš€ Iniciando criaÃ§Ã£o de estrutura...', 'warning');
      
      // Obter turmas selecionadas
      const turmas = [];
      if (document.getElementById('turma6ano').checked) turmas.push('6ano');
      if (document.getElementById('turma7ano').checked) turmas.push('7ano');
      if (document.getElementById('turma8ano').checked) turmas.push('8ano');
      if (document.getElementById('turma9ano').checked) turmas.push('9ano');

      if (turmas.length === 0) {
        addLog('Nenhuma turma selecionada!', 'error');
        return;
      }

      addLog(`Turmas selecionadas: ${turmas.join(', ')}`, 'info');
      addLog(`Disciplinas: ${DISCIPLINAS.join(', ')}`, 'info');
      addLog(`Tipos: ${TIPOS.join(', ')}`, 'info');

      let totalPastas = 0;
      let erros = 0;

      // Para cada disciplina
      for (const disciplina of DISCIPLINAS) {
        // Para cada turma
        for (const turma of turmas) {
          // Para cada tipo
          for (const tipo of TIPOS) {
            const caminhoCompleto = `professor/${disciplina}/${turma}/${tipo}/.gitkeep`;
            
            try {
              addLog(`ğŸ“ Criando: professor/${disciplina}/${turma}/${tipo}/`, 'info');
              
              // Fazer upload de um arquivo vazio para criar a pasta
              const { error } = await supabaseClient.storage
                .from('DBEscola')
                .upload(caminhoCompleto, new Blob([''], { type: 'text/plain' }), {
                  cacheControl: '3600',
                  upsert: false
                });

              if (error) {
                if (error.message.includes('already exists')) {
                  addLog(`âš ï¸ Pasta jÃ¡ existe: professor/${disciplina}/${turma}/${tipo}/`, 'warning');
                } else {
                  addLog(`âŒ Erro ao criar: ${error.message}`, 'error');
                  erros++;
                }
              } else {
                addLog(`âœ… Criada: professor/${disciplina}/${turma}/${tipo}/`, 'success');
                totalPastas++;
              }
            } catch (e) {
              addLog(`âŒ ExceÃ§Ã£o: ${e.message}`, 'error');
              erros++;
            }

            // Pequeno delay para nÃ£o sobrecarregar
            await new Promise(resolve => setTimeout(resolve, 200));
          }
        }
      }

      addLog('', 'info');
      addLog(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');
      addLog(`ğŸ¯ Resumo Final:`, 'warning');
      addLog(`âœ… Pastas criadas: ${totalPastas}`, 'success');
      addLog(`âŒ Erros: ${erros}`, erros > 0 ? 'error' : 'success');
      addLog(`ğŸ“Š Total esperado: ${DISCIPLINAS.length * turmas.length * TIPOS.length}`, 'info');
      addLog(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');
      addLog('âœ¨ Processo concluÃ­do! Agora vocÃª pode fazer upload de arquivos.', 'success');
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
