<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - L√≠ngua Portuguesa</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <!-- NAVBAR DO DASHBOARD -->
  <nav class="navbar navbar-dark bg-dark">
    
    <div class="container-fluid">
      <span class="navbar-brand">üìö √Årea do Professor - L√≠ngua Portuguesa</span>
      <button id="logoutBtn" class="btn btn-outline-light btn-sm">Sair</button>
    </div>
  </nav>

  <!-- CONTE√öDO PRINCIPAL -->
  <div class="container mt-4">

    <!-- SELETOR DE TURMA -->
    <div class="row mb-4">
      <div class="col-md-4">
        <label for="seletorTurma" class="form-label fw-bold">Selecione a Turma:</label>
        <select id="seletorTurma" class="form-select" onchange="trocarTurma()">
          <option value="">-- Escolha uma turma --</option>
          <option value="6ano">6¬∫ Ano</option>
          <option value="7ano">7¬∫ Ano</option>
          <option value="8ano">8¬∫ Ano</option>
          <option value="9ano">9¬∫ Ano</option>
        </select>
      </div>
    </div>

    <!-- AVISO QUANDO NENHUMA TURMA SELECIONADA -->
    <div id="avisoTurma" class="alert alert-warning" role="alert">
      ‚ö†Ô∏è Selecione uma turma para come√ßar
    </div>

    <!-- CONTE√öDO (ESCONDIDO AT√â SELECIONAR TURMA) -->
    <div id="conteudoTurma" style="display: none;">

  <h4 id="titulaTurma" class="mb-4"></h4>

  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="atividades-tab" data-bs-toggle="tab" data-bs-target="#atividades" type="button" role="tab">
        Atividade Di√°ria
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="materiais-tab" data-bs-toggle="tab" data-bs-target="#materiais" type="button" role="tab">
        Material Extra
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="chamada-tab" data-bs-toggle="tab" data-bs-target="#chamada" type="button" role="tab">
        Chamada
      </button>
    </li>
  </ul>

  <!-- CONTE√öDO DAS ABAS -->
  <div class="tab-content">

    <!-- ABA 1: ATIVIDADE DI√ÅRIA -->
    <div class="tab-pane fade show active" id="atividades" role="tabpanel">
      <div class="card p-4">
        <h5 class="card-title mb-4">Enviar Atividade Di√°ria</h5>
        <div class="row">
          <div class="col-md-6">
            <input type="file" id="arquivoAtividade" class="form-control mb-2">
            <button class="btn btn-success" onclick="uploadAtividade()">Enviar Atividade</button>
            <p id="msgAtividade" class="mt-2"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ABA 2: MATERIAL EXTRA -->
    <div class="tab-pane fade" id="materiais" role="tabpanel">
      <div class="card p-4">
        <h5 class="card-title mb-4">Enviar Material Extra</h5>
        <div class="row">
          <div class="col-md-6">
            <input type="file" id="arquivoMaterial" class="form-control mb-2">
            <button class="btn btn-success" onclick="uploadMaterial()">Enviar Material</button>
            <p id="msgMaterial" class="mt-2"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ABA 3: CHAMADA -->
    <div class="tab-pane fade" id="chamada" role="tabpanel">
      <div class="card p-4">
        <h5 class="card-title mb-4">Registro de Chamada</h5>
        <p class="text-muted">Funcionalidade em desenvolvimento</p>
      </div>
    </div>

  </div>
  </div>

</div>

<script>
let turmaAtual = '';
const nomeTurmas = {
  '6ano': '6¬∫ Ano - Ensino Fundamental',
  '7ano': '7¬∫ Ano - Ensino Fundamental',
  '8ano': '8¬∫ Ano - Ensino Fundamental',
  '9ano': '9¬∫ Ano - Ensino Fundamental'
}

function trocarTurma() {
  turmaAtual = document.getElementById('seletorTurma').value
  
  if (turmaAtual) {
    document.getElementById('avisoTurma').style.display = 'none'
    document.getElementById('conteudoTurma').style.display = 'block'
    document.getElementById('titulaTurma').textContent = 'üìö ' + nomeTurmas[turmaAtual]
    
    // Limpar campos de arquivo e mensagens
    document.getElementById('arquivoAtividade').value = ''
    document.getElementById('arquivoMaterial').value = ''
    document.getElementById('msgAtividade').textContent = ''
    document.getElementById('msgMaterial').textContent = ''
  } else {
    document.getElementById('avisoTurma').style.display = 'block'
    document.getElementById('conteudoTurma').style.display = 'none'
  }
}

// Upload de Atividade Di√°ria
async function uploadAtividade() {
  if (!turmaAtual) {
    alert('Selecione uma turma primeiro!')
    return
  }
  await uploadArquivo('arquivoAtividade', 'msgAtividade', `${turmaAtual}/atividade`)
}

// Upload de Material Extra
async function uploadMaterial() {
  if (!turmaAtual) {
    alert('Selecione uma turma primeiro!')
    return
  }
  await uploadArquivo('arquivoMaterial', 'msgMaterial', `${turmaAtual}/material`)
}

// Fun√ß√£o gen√©rica de upload
async function uploadArquivo(inputId, msgId, caminhoTurma) {
  const fileInput = document.getElementById(inputId)
  const msg = document.getElementById(msgId)

  if (!fileInput.files.length) {
    msg.textContent = 'Selecione um arquivo'
    msg.className = 'mt-2 text-danger'
    return
  }

  msg.textContent = 'Enviando...'
  msg.className = 'mt-2 text-info'

  const file = fileInput.files[0]
  
  // Sanitizar nome do arquivo removendo acentos e espa√ßos
  const sanitizedName = file.name
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '') // Remove acentos
    .replace(/\s+/g, '_') // Substitui espa√ßos por underscore
    .replace(/[^a-zA-Z0-9._-]/g, '') // Remove caracteres especiais
  
  const filePath = `professor/${caminhoTurma}/${Date.now()}_${sanitizedName}`

  const { error } = await supabaseClient.storage
    .from('DBEscola')
    .upload(filePath, file)

  if (error) {
    console.error(error)
    msg.textContent = 'Erro ao enviar arquivo'
    msg.className = 'mt-2 text-danger'
  } else {
    msg.textContent = 'Arquivo enviado com sucesso! ‚úì'
    msg.className = 'mt-2 text-success'
    fileInput.value = ''
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = 'https://brauqbxjvixrennhyqrk.supabase.co'
  const supabaseKey = 'sb_publishable_4x7IM5uariLJS8hW1YO8KA_bK0sngvi'

  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey)

  // Verificar autentica√ß√£o do Supabase
  supabaseClient.auth.onAuthStateChange((event, session) => {
    if (!session) {
      // N√£o autenticado: redireciona
      window.location.href = "index.html";
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabaseClient.auth.signOut()
    window.location.href = "index.html"
  })
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
