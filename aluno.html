<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      overflow-x: hidden;
    }
    .container {
      min-height: 100vh;
      padding-bottom: 50px;
    }
    #materiaisPorDisciplina {
      padding-bottom: 30px;
    }
  </style>
</head>
<body class="bg-light">
  <!-- NAVBAR DO DASHBOARD -->
  <nav class="navbar navbar-dark bg-dark">
    
    <div class="container-fluid">
<span class="navbar-brand">√Årea do Aluno</span>
<span class="text-light ms-auto me-3" id="nomeAluno"></span>
<button id="logoutBtn" class="btn btn-outline-light btn-sm">Sair</button>
    </div>
  </nav>
  <!-- CONTE√öDO PRINCIPAL -->
  <div class="container mt-4">
    <h2 class="mb-4" >üìö AVA - ALUNO</h2>
    <div class="row g-4">

<!-- BLOCO DE MENSAGENS/INSTRU√á√ïES DO PROFESSOR -->
<div id="blocoMensagem" style="display: none;">
  <div class="card mb-4 border-info">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">üì¢ Instru√ß√µes do Professor</h5>
    </div>
    <div class="card-body">
      <p id="textoMensagem" class="mb-0"></p>
    </div>
  </div>
</div>

<h3 class="mb-3">üìò Disciplinas</h3>

<h4>Materiais dispon√≠veis
  <button class="btn btn-sm btn-secondary" onclick="carregarArquivos()">üîÑ Recarregar</button>
</h4>
<div id="infoTurma" class="alert alert-info"></div>
<div id="materiaisPorDisciplina"></div>

<script>
let turmaAluno = '';

// Disciplinas com seus poss√≠veis nomes de pasta
const DISCIPLINAS = [
  { nome: 'Portugu√™s', pasta: 'portugues' },
  { nome: 'Matem√°tica', pasta: 'matematica' },
  { nome: 'Ci√™ncias', pasta: 'ciencias' },
  { nome: 'Hist√≥ria', pasta: 'historia' },
  { nome: 'Geografia', pasta: 'geografia' },
  { nome: 'Artes', pasta: 'artes' },
  { nome: 'Educa√ß√£o F√≠sica', pasta: 'educacaofisica' },
  { nome: 'Ingl√™s', pasta: 'ingles' },
  { nome: 'Gram√°tica', pasta: 'gramatica' },
  { nome: 'Socioemocional', pasta: 'socioemocional' }
];

// Carregar mensagem da turma
async function carregarMensagemTurma(turma) {
  try {
    const { data, error } = await supabaseClient
      .from('mensagens_turma')
      .select('conteudo, professor_nome, professor_disciplina')
      .eq('turma', turma)
      .single()

    if (error) {
      console.log('Nenhuma mensagem definida para esta turma')
      return
    }

    if (data && data.conteudo) {
      const infoProfessor = data.professor_nome ? `<strong>Prof. ${data.professor_nome}</strong> (${data.professor_disciplina || 'Portugu√™s'}):` : ''
      const textoExibi√ß√£o = infoProfessor ? `${infoProfessor} ${data.conteudo}` : data.conteudo
      document.getElementById('textoMensagem').innerHTML = textoExibi√ß√£o
      document.getElementById('blocoMensagem').style.display = 'block'
    }
  } catch (error) {
    console.error('Erro ao carregar mensagem:', error)
  }
}

// Obter turma do aluno logado
async function obterTurmaAluno(email) {
  const { data, error } = await supabaseClient
    .from('alunos')
    .select('turma, nome')
    .eq('email', email)
    .single()

  if (error) {
    console.error('Erro ao obter turma:', error)
    if (error.code === 'PGRST116') {
      document.getElementById('infoTurma').innerHTML = `‚ö†Ô∏è Aluno n√£o encontrado no sistema.<br>
        <small>Por favor, fa√ßa seu cadastro primeiro em <a href="cadastro.html">cadastro.html</a></small>`
    } else {
      document.getElementById('infoTurma').innerHTML = '‚ö†Ô∏è Erro ao carregar seus dados: ' + error.message
    }
    return null
  }

  return data
}

// Obter nome do professor de uma disciplina
async function obterNomeProfessor(disciplinaPasta) {
  try {
    // Tentar buscar todos os professores e filtrar no cliente
    const { data, error } = await supabaseClient
      .from('professores')
      .select('nome, disciplina')

    if (error) {
      console.log(`Erro ao buscar professores: ${error.message}`)
      return null
    }

    if (!data || data.length === 0) {
      return null
    }

    // Buscar o professor cuja disciplina contenha a disciplina_pasta (sem acentos)
    const professor = data.find(prof => {
      if (!prof.disciplina) return false
      const disciplinaLower = prof.disciplina.toLowerCase()
      // Remove acentos e compara
      const normalized = disciplinaLower
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
      return normalized.includes(disciplinaPasta)
    })

    return professor ? professor.nome : null
  } catch (e) {
    console.log(`Erro ao buscar professor: ${e.message}`)
    return null
  }
}

async function carregarArquivos() {
  // Se turma ainda n√£o foi carregada, carregar agora
  if (!turmaAluno) {
    const session = await supabaseClient.auth.getSession()
    if (!session.data.session) {
      document.getElementById('infoTurma').innerHTML = '‚ö†Ô∏è Voc√™ precisa estar autenticado'
      return
    }

    const alunoData = await obterTurmaAluno(session.data.session.user.email)
    if (!alunoData) return
    document.getElementById('nomeAluno').textContent = `üë§ ${alunoData.nome}`

    turmaAluno = alunoData.turma
    document.getElementById('infoTurma').innerHTML = `üìö Turma: <strong>${turmaAluno === '6ano' ? '6¬∫ Ano' : turmaAluno === '7ano' ? '7¬∫ Ano' : turmaAluno === '8ano' ? '8¬∫ Ano' : '9¬∫ Ano'}</strong>`
    
    // Carregar mensagem da turma
    carregarMensagemTurma(turmaAluno)
  }

  const container = document.getElementById('materiaisPorDisciplina')
  container.innerHTML = '<div class="text-center mt-3"><div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div></div>'

  let temAlgumaMateria = false
  let htmlDisciplinas = ''

  // Iterar por cada disciplina
  for (const disciplina of DISCIPLINAS) {
    console.log(`\nüìö Processando disciplina: ${disciplina.nome} (pasta: ${disciplina.pasta})`)
    
    let arquivosMateria = []

    // Procurar materiais e atividades
    for (const tipo of ['material', 'atividade']) {
      const caminhoCompleto = `professor/${disciplina.pasta}/${turmaAluno}/${tipo}`
      console.log(`üîç Procurando em: ${caminhoCompleto}`)

      const { data, error } = await supabaseClient.storage
        .from('DBEscola')
        .list(caminhoCompleto)

      if (error) {
        console.log(`‚ö†Ô∏è Erro: ${error.message}`)
        continue
      }

      if (data && data.length > 0) {
        console.log(`‚úÖ Encontrados ${data.length} itens em ${tipo}`)
        
        for (const item of data) {
          if (item.id) {
            const filePath = `professor/${disciplina.pasta}/${turmaAluno}/${tipo}/${item.name}`
            const { data: urlData } = supabaseClient.storage
              .from('DBEscola')
              .getPublicUrl(filePath)

            arquivosMateria.push({
              nome: item.name,
              url: urlData.publicUrl,
              tipo: tipo
            })
          }
        }
      }
    }

    // Se encontrou arquivos nesta disciplina
    if (arquivosMateria.length > 0) {
      temAlgumaMateria = true
      
      // Obter nome do professor
      const nomeProfessor = await obterNomeProfessor(disciplina.pasta)
      const labelProfessor = nomeProfessor ? ` ‚Ä¢ Prof. ${nomeProfessor}` : ''

      // Montar HTML da disciplina
      htmlDisciplinas += `
        <div class="mt-4">
          <h5 class="border-bottom pb-2" style="color: #0d6efd;">
            üìñ ${disciplina.nome}${labelProfessor}
            <button class="btn btn-sm btn-info ms-2" onclick="abrirModalBoletim('${disciplina.pasta}', '${disciplina.nome}')">
              üìä Boletim
            </button>
            <button class="btn btn-sm btn-warning ms-2" onclick="abrirModalEnviarAtividade('${disciplina.pasta}', '${disciplina.nome}')">
              üì§ Enviar Atividade
            </button>
          </h5>
          <ul class="list-group mt-3">
      `

      // Adicionar materiais
      for (const arquivo of arquivosMateria) {
        const icone = arquivo.tipo === 'atividade' ? '‚úèÔ∏è' : 'üìÑ'
        const badge = arquivo.tipo === 'atividade' ? '<span class="badge bg-warning text-dark ms-2">Atividade</span>' : '<span class="badge bg-info text-dark ms-2">Material</span>'
        
        htmlDisciplinas += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${icone} ${arquivo.nome}${badge}</span>
            <a href="${arquivo.url}" target="_blank" download class="btn btn-sm btn-primary">
              ‚¨áÔ∏è Baixar
            </a>
          </li>
        `
      }

      htmlDisciplinas += `
          </ul>
        </div>
      `
    }
  }

  // Mostrar resultado
  if (temAlgumaMateria) {
    container.innerHTML = htmlDisciplinas
  } else {
    container.innerHTML = `
      <div class="alert alert-warning mt-3">
        ‚ùå Nenhum material dispon√≠vel para sua turma (${turmaAluno})
        <br><small style="color: #666; margin-top: 5px; display: block;">
          Os professores ainda n√£o enviaram materiais ou atividades.
        </small>
      </div>
    `
  }
}

// Carregar arquivos quando a p√°gina estiver pronta
setTimeout(() => {
  carregarArquivos()
}, 1000)


// Carregar arquivos quando a p√°gina estiver pronta
setTimeout(() => {
  carregarArquivos()
}, 1000)

// Modal para abrir boletim
async function abrirModalBoletim(disciplinaPasta, disciplinaNome) {
  const session = await supabaseClient.auth.getSession()
  if (!session.data.session) {
    alert('Voc√™ precisa estar autenticado')
    return
  }

  const alunoId = session.data.session.user.id
  
  try {
    // Buscar notas do aluno nesta disciplina
    const { data: notas, error } = await supabaseClient
      .from('notas')
      .select('*')
      .eq('aluno_id', alunoId)
      .eq('disciplina', disciplinaPasta)
      .order('data_criacao', { ascending: false })

    if (error) {
      console.error('Erro ao carregar boletim:', error)
      alert('Erro ao carregar boletim')
      return
    }

    // Montar HTML do boletim
    let htmlBoletim = ''
    if (notas && notas.length > 0) {
      htmlBoletim = '<table class="table table-sm"><thead><tr><th>Data</th><th>Nota</th><th>Feedback</th><th>Professor</th></tr></thead><tbody>'
      
      for (const nota of notas) {
        const dataCriacao = new Date(nota.data_criacao).toLocaleDateString('pt-BR')
        const feedbackTexto = nota.feedback || '‚Äî'
        const professorNome = nota.professor_nome || 'Sem info'
        const notaValor = nota.valor !== null ? nota.valor.toFixed(1) : '‚Äî'
        
        htmlBoletim += `
          <tr>
            <td>${dataCriacao}</td>
            <td><strong>${notaValor}</strong></td>
            <td>${feedbackTexto}</td>
            <td>${professorNome}</td>
          </tr>
        `
      }
      
      htmlBoletim += '</tbody></table>'
    } else {
      htmlBoletim = '<div class="alert alert-info">Nenhuma nota registrada ainda para esta disciplina.</div>'
    }

    // Exibir no modal
    document.getElementById('conteudoBoletimDisciplina').innerHTML = htmlBoletim
    document.getElementById('disciplinaNomeBoletim').textContent = disciplinaNome
    const modal = new bootstrap.Modal(document.getElementById('modalBoletim'), {})
    modal.show()
  } catch (error) {
    console.error('Erro:', error)
    alert('Erro ao carregar boletim: ' + error.message)
  }
}

// Modal para enviar atividade
function abrirModalEnviarAtividade(disciplinaPasta, disciplinaNome) {
  const modal = new bootstrap.Modal(document.getElementById('modalEnviarAtividade'), {})
  document.getElementById('disciplinaAtualModal').value = disciplinaPasta
  document.getElementById('disciplinaNomeModal').textContent = disciplinaNome
  document.getElementById('msgEnvioAtividade').textContent = ''
  document.getElementById('fileInputAtividade').value = ''
  modal.show()
}

// Enviar atividade
async function enviarAtividade() {
  const fileInput = document.getElementById('fileInputAtividade')
  const disciplinaPasta = document.getElementById('disciplinaAtualModal').value
  const msgDiv = document.getElementById('msgEnvioAtividade')

  if (!fileInput.files.length) {
    msgDiv.textContent = '‚ö†Ô∏è Selecione um arquivo'
    msgDiv.className = 'text-danger mt-2'
    return
  }

  const file = fileInput.files[0]
  msgDiv.textContent = 'Enviando...'
  msgDiv.className = 'text-info mt-2'

  try {
    const session = await supabaseClient.auth.getSession()
    if (!session.data.session) {
      throw new Error('Voc√™ precisa estar autenticado')
    }

    const alunoEmail = session.data.session.user.email
    const alunoData = await obterTurmaAluno(alunoEmail)
    if (!alunoData) throw new Error('Dados do aluno n√£o encontrados')

    // Sanitizar nome do arquivo
    const sanitizedName = file.name
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, '_')
      .replace(/[^a-zA-Z0-9._-]/g, '')

    const filePath = `aluno/atividades/${disciplinaPasta}/${alunoData.turma}/${Date.now()}_${sanitizedName}`

    // Upload do arquivo
    const { error: uploadError } = await supabaseClient.storage
      .from('DBEscola')
      .upload(filePath, file)

    if (uploadError) throw uploadError

    // Registrar atividade no banco de dados
    const { error: dbError } = await supabaseClient
      .from('atividades')
      .insert([{
        aluno_id: session.data.session.user.id,
        aluno_nome: alunoData.nome,
        turma: alunoData.turma,
        disciplina: disciplinaPasta,
        arquivo_path: filePath
      }])

    if (dbError) throw dbError

    msgDiv.textContent = '‚úÖ Atividade enviada com sucesso!'
    msgDiv.className = 'text-success mt-2'
    
    setTimeout(() => {
      bootstrap.Modal.getInstance(document.getElementById('modalEnviarAtividade')).hide()
      carregarArquivos() // Recarregar para mostrar a atividade enviada
    }, 1500)
  } catch (error) {
    console.error(error)
    msgDiv.textContent = '‚ùå Erro: ' + error.message
    msgDiv.className = 'text-danger mt-2'
  }
}</script>

<!-- MODAL DO BOLETIM -->
<div class="modal fade" id="modalBoletim" tabindex="-1" aria-labelledby="modalBoletimLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalBoletimLabel">üìä Boletim - <span id="disciplinaNomeBoletim"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="conteudoBoletimDisciplina"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARA ENVIAR ATIVIDADE -->
<div class="modal fade" id="modalEnviarAtividade" tabindex="-1" aria-labelledby="modalEnviarAtividadeLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEnviarAtividadeLabel">üì§ Enviar Atividade</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Disciplina:</strong> <span id="disciplinaNomeModal"></span></p>
        <label for="fileInputAtividade" class="form-label">Selecione o arquivo:</label>
        <input type="file" id="fileInputAtividade" class="form-control" accept=".pdf,.doc,.docx,.txt,.jpg,.png,.xlsx">
        <input type="hidden" id="disciplinaAtualModal">
        <div id="msgEnvioAtividade"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="enviarAtividade()">Enviar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = 'https://brauqbxjvixrennhyqrk.supabase.co'
  const supabaseKey = 'sb_publishable_4x7IM5uariLJS8hW1YO8KA_bK0sngvi'

  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey)

  // Verificar autentica√ß√£o do Supabase
  supabaseClient.auth.onAuthStateChange((event, session) => {
    if (!session) {
      // N√£o autenticado: redireciona
      window.location.href = "index.html";
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabaseClient.auth.signOut()
    window.location.href = "index.html"
  })
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
