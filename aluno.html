<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      overflow-x: hidden;
    }
    .container {
      min-height: 100vh;
      padding-bottom: 50px;
    }
    #materiaisPorDisciplina {
      padding-bottom: 30px;
    }
  </style>
</head>
<body class="bg-light">
  <!-- NAVBAR DO DASHBOARD -->
  <nav class="navbar navbar-dark bg-dark">
    
    <div class="container-fluid">
<span class="navbar-brand">Ãrea do Aluno</span>
<span class="text-light ms-auto me-3" id="nomeAluno"></span>
<button id="logoutBtn" class="btn btn-outline-light btn-sm">Sair</button>
    </div>
  </nav>
  <!-- CONTEÃšDO PRINCIPAL -->
  <div class="container mt-4">
    <h2 class="mb-4" >ğŸ“š Meus ConteÃºdos</h2>
    <div class="row g-4">

<h3 class="mb-3">ğŸ“˜ Disciplinas</h3>

<h4>Materiais disponÃ­veis
  <button class="btn btn-sm btn-secondary" onclick="carregarArquivos()">ğŸ”„ Recarregar</button>
</h4>
<div id="infoTurma" class="alert alert-info"></div>
<div id="materiaisPorDisciplina"></div>

<script>
let turmaAluno = '';

// Disciplinas com seus possÃ­veis nomes de pasta
const DISCIPLINAS = [
  { nome: 'PortuguÃªs', pasta: 'portugues' },
  { nome: 'MatemÃ¡tica', pasta: 'matematica' },
  { nome: 'CiÃªncias', pasta: 'ciencias' },
  { nome: 'HistÃ³ria', pasta: 'historia' },
  { nome: 'Geografia', pasta: 'geografia' },
  { nome: 'Artes', pasta: 'artes' },
  { nome: 'EducaÃ§Ã£o FÃ­sica', pasta: 'educacaofisica' },
  { nome: 'InglÃªs', pasta: 'ingles' },
  { nome: 'GramÃ¡tica', pasta: 'gramatica' },
  { nome: 'Socioemocional', pasta: 'socioemocional' }
];

// Obter turma do aluno logado
async function obterTurmaAluno(email) {
  const { data, error } = await supabaseClient
    .from('alunos')
    .select('turma, nome')
    .eq('email', email)
    .single()

  if (error) {
    console.error('Erro ao obter turma:', error)
    if (error.code === 'PGRST116') {
      document.getElementById('infoTurma').innerHTML = `âš ï¸ Aluno nÃ£o encontrado no sistema.<br>
        <small>Por favor, faÃ§a seu cadastro primeiro em <a href="cadastro.html">cadastro.html</a></small>`
    } else {
      document.getElementById('infoTurma').innerHTML = 'âš ï¸ Erro ao carregar seus dados: ' + error.message
    }
    return null
  }

  return data
}

// Obter nome do professor de uma disciplina
async function obterNomeProfessor(disciplinaPasta) {
  try {
    // Tentar buscar todos os professores e filtrar no cliente
    const { data, error } = await supabaseClient
      .from('professores')
      .select('nome, disciplina')

    if (error) {
      console.log(`Erro ao buscar professores: ${error.message}`)
      return null
    }

    if (!data || data.length === 0) {
      return null
    }

    // Buscar o professor cuja disciplina contenha a disciplina_pasta (sem acentos)
    const professor = data.find(prof => {
      if (!prof.disciplina) return false
      const disciplinaLower = prof.disciplina.toLowerCase()
      // Remove acentos e compara
      const normalized = disciplinaLower
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
      return normalized.includes(disciplinaPasta)
    })

    return professor ? professor.nome : null
  } catch (e) {
    console.log(`Erro ao buscar professor: ${e.message}`)
    return null
  }
}

async function carregarArquivos() {
  // Se turma ainda nÃ£o foi carregada, carregar agora
  if (!turmaAluno) {
    const session = await supabaseClient.auth.getSession()
    if (!session.data.session) {
      document.getElementById('infoTurma').innerHTML = 'âš ï¸ VocÃª precisa estar autenticado'
      return
    }

    const alunoData = await obterTurmaAluno(session.data.session.user.email)
    if (!alunoData) return
    document.getElementById('nomeAluno').textContent = `ğŸ‘¤ ${alunoData.nome}`

    turmaAluno = alunoData.turma
    document.getElementById('infoTurma').innerHTML = `ğŸ“š Turma: <strong>${turmaAluno === '6ano' ? '6Âº Ano' : turmaAluno === '7ano' ? '7Âº Ano' : turmaAluno === '8ano' ? '8Âº Ano' : '9Âº Ano'}</strong>`
  }

  const container = document.getElementById('materiaisPorDisciplina')
  container.innerHTML = '<div class="text-center mt-3"><div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div></div>'

  let temAlgumaMateria = false
  let htmlDisciplinas = ''

  // Iterar por cada disciplina
  for (const disciplina of DISCIPLINAS) {
    console.log(`\nğŸ“š Processando disciplina: ${disciplina.nome} (pasta: ${disciplina.pasta})`)
    
    let arquivosMateria = []

    // Procurar materiais e atividades
    for (const tipo of ['material', 'atividade']) {
      const caminhoCompleto = `professor/${disciplina.pasta}/${turmaAluno}/${tipo}`
      console.log(`ğŸ” Procurando em: ${caminhoCompleto}`)

      const { data, error } = await supabaseClient.storage
        .from('DBEscola')
        .list(caminhoCompleto)

      if (error) {
        console.log(`âš ï¸ Erro: ${error.message}`)
        continue
      }

      if (data && data.length > 0) {
        console.log(`âœ… Encontrados ${data.length} itens em ${tipo}`)
        
        for (const item of data) {
          if (item.id) {
            const filePath = `professor/${disciplina.pasta}/${turmaAluno}/${tipo}/${item.name}`
            const { data: urlData } = supabaseClient.storage
              .from('DBEscola')
              .getPublicUrl(filePath)

            arquivosMateria.push({
              nome: item.name,
              url: urlData.publicUrl,
              tipo: tipo
            })
          }
        }
      }
    }

    // Se encontrou arquivos nesta disciplina
    if (arquivosMateria.length > 0) {
      temAlgumaMateria = true
      
      // Obter nome do professor
      const nomeProfessor = await obterNomeProfessor(disciplina.pasta)
      const labelProfessor = nomeProfessor ? ` â€¢ Prof. ${nomeProfessor}` : ''

      // Montar HTML da disciplina
      htmlDisciplinas += `
        <div class="mt-4">
          <h5 class="border-bottom pb-2" style="color: #0d6efd;">
            ğŸ“– ${disciplina.nome}${labelProfessor}
          </h5>
          <ul class="list-group mt-3">
      `

      // Adicionar materiais
      for (const arquivo of arquivosMateria) {
        const icone = arquivo.tipo === 'atividade' ? 'âœï¸' : 'ğŸ“„'
        const badge = arquivo.tipo === 'atividade' ? '<span class="badge bg-warning text-dark ms-2">Atividade</span>' : '<span class="badge bg-info text-dark ms-2">Material</span>'
        
        htmlDisciplinas += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${icone} ${arquivo.nome}${badge}</span>
            <a href="${arquivo.url}" target="_blank" download class="btn btn-sm btn-primary">
              â¬‡ï¸ Baixar
            </a>
          </li>
        `
      }

      htmlDisciplinas += `
          </ul>
        </div>
      `
    }
  }

  // Mostrar resultado
  if (temAlgumaMateria) {
    container.innerHTML = htmlDisciplinas
  } else {
    container.innerHTML = `
      <div class="alert alert-warning mt-3">
        âŒ Nenhum material disponÃ­vel para sua turma (${turmaAluno})
        <br><small style="color: #666; margin-top: 5px; display: block;">
          Os professores ainda nÃ£o enviaram materiais ou atividades.
        </small>
      </div>
    `
  }
}

// Carregar arquivos quando a pÃ¡gina estiver pronta
setTimeout(() => {
  carregarArquivos()
}, 1000)


// Carregar arquivos quando a pÃ¡gina estiver pronta
setTimeout(() => {
  carregarArquivos()
}, 1000)
</script>



<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = 'https://brauqbxjvixrennhyqrk.supabase.co'
  const supabaseKey = 'sb_publishable_4x7IM5uariLJS8hW1YO8KA_bK0sngvi'

  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey)

  // Verificar autenticaÃ§Ã£o do Supabase
  supabaseClient.auth.onAuthStateChange((event, session) => {
    if (!session) {
      // NÃ£o autenticado: redireciona
      window.location.href = "index.html";
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabaseClient.auth.signOut()
    window.location.href = "index.html"
  })
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
